import{u as V,r as s,j as r,P as A,M as L,V as U,X as _}from"./main-CZZoxSPi.js";import{$ as F,P as $,M as H,V as J}from"./bundler-v5uTwFHc.js";const z=({children:o,onClose:l,wide:d=!1})=>r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4",onClick:l,children:r.jsxs("div",{className:`bg-[rgb(var(--color-surface))] rounded-lg shadow-xl p-6 w-full ${d?"max-w-lg":"max-w-sm"} relative`,onClick:n=>n.stopPropagation(),children:[r.jsx("button",{onClick:l,className:"absolute top-3 right-3 p-1 rounded-full text-[rgb(var(--color-text-secondary))] hover:bg-[rgb(var(--color-surface-hover))]",children:r.jsx(_,{size:20})}),o]})}),q=()=>{const{user:o}=V(),[l,d]=s.useState(null),[n,N]=s.useState(null),[f,y]=s.useState(null),[c,k]=s.useState(null),[p,v]=s.useState(!1),[g,C]=s.useState(!1),[M,i]=s.useState(null),h=s.useRef(null),m=s.useRef(null),b=s.useRef(n),P=s.useRef(l);s.useEffect(()=>{b.current=n,P.current=l},[n,l]);const j=s.useCallback(async e=>{i(null);const t={audio:!0,video:e==="video"};try{const a=await navigator.mediaDevices.getUserMedia(t);return y(a),e==="video"&&C(!1),v(!1),a}catch(a){return console.error("Error getting user media:",a),a.name==="NotFoundError"||a.name==="DevicesNotFoundError"?i("No microphone or camera found."):a.name==="NotAllowedError"||a.name==="PermissionDeniedError"?i(e==="video"?"Microphone/Camera access denied.":"Microphone access denied."):i("Error accessing media devices."),y(null),v(!0),e==="video"&&C(!0),new MediaStream}},[]),u=s.useCallback(()=>{m.current&&(m.current.close(),m.current=null),f?.getTracks().forEach(e=>e.stop()),c?.getTracks().forEach(e=>e.stop()),y(null),k(null),N(null),d(null),v(!1),C(!1),i(null)},[f,c]),S=s.useCallback(()=>{u()},[u]),I=s.useCallback(async(e,t)=>{if(!o||b.current||!h.current)return;const a=await j(t);N({with:e,type:t,isCaller:!0});const x={from:o,type:t},w=h.current.call(e.id,a,{metadata:x});m.current=w,w.on("stream",E=>{k(E)}),w.on("close",()=>{u()}),w.on("error",E=>{console.error("Peer call error:",E),u()})},[o,j,u]),T=s.useCallback(async()=>{if(!l||!o)return;const e=await j(l.type);N({with:l.from,type:l.type,isCaller:!1}),l.peerCall.answer(e),m.current=l.peerCall,l.peerCall.on("stream",t=>{k(t)}),l.peerCall.on("close",()=>{u()}),l.peerCall.on("error",t=>{console.error("Peer call error:",t),u()}),d(null)},[o,l,j,u]),R=s.useCallback(()=>{l&&l.peerCall.close(),d(null)},[l]);s.useEffect(()=>{const e=t=>{const{targetUser:a,type:x}=t.detail;I(a,x)};return window.addEventListener("startCall",e),()=>window.removeEventListener("startCall",e)},[I]),s.useEffect(()=>{if(!o||h.current)return;const e=new F(o.id);return h.current=e,e.on("open",t=>{console.log("PeerJS connected with ID:",t)}),e.on("call",t=>{const a=t.metadata;if(b.current||P.current){t.close();return}t.on("close",()=>{d(x=>x?.peerCall===t?null:x)}),d({from:a.from,type:a.type,peerCall:t})}),e.on("error",t=>{console.error("PeerJS error:",t),t.type==="peer-unavailable"&&b.current&&!m.current?.open&&i(`${b.current.with.display_name} is unreachable.`)}),()=>{e.destroy(),h.current=null}},[o]);const O=()=>{const e=f?.getAudioTracks()||[];e.length>0?(e.forEach(t=>{t.enabled=!t.enabled}),v(!p)):i("No microphone track available.")},D=()=>{const e=f?.getVideoTracks()||[];e.length>0?(e.forEach(t=>{t.enabled=!t.enabled}),C(!g)):i("No camera track available.")};return l?r.jsx(z,{onClose:R,children:r.jsxs("div",{className:"text-center text-[rgb(var(--color-text))]",children:[r.jsx("h3",{className:"text-xl font-bold",children:l.from.display_name}),r.jsxs("p",{className:"text-[rgb(var(--color-text-secondary))]",children:["Incoming ",l.type," call..."]}),r.jsxs("div",{className:"flex justify-center gap-4 mt-6",children:[r.jsx("button",{onClick:R,className:"p-4 rounded-full bg-red-600 text-white transition hover:bg-red-700",title:"Deny",children:r.jsx($,{size:24})}),r.jsx("button",{onClick:T,className:"p-4 rounded-full bg-green-500 text-white transition hover:bg-green-600",title:"Answer",children:r.jsx(A,{size:24})})]})]})}):n?r.jsx(z,{onClose:S,wide:!0,children:r.jsxs("div",{className:"text-center text-[rgb(var(--color-text))]",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2",children:[n.isCaller&&!c?"Ringing...":"",!n.isCaller||c?`In call with ${n.with.display_name}`:"",n.isCaller&&!c&&r.jsx("span",{className:"block text-sm font-normal text-[rgb(var(--color-text-secondary))]",children:"Waiting for answer..."})]}),M&&r.jsx("p",{className:"text-red-500 text-sm mb-3 bg-red-100 dark:bg-red-900/30 p-2 rounded",children:M}),r.jsxs("div",{className:"relative w-full aspect-video bg-black rounded-lg mb-4 overflow-hidden",children:[r.jsx("video",{ref:e=>{e&&(e.srcObject=c)},autoPlay:!0,playsInline:!0,className:`w-full h-full object-cover ${c?"":"hidden"}`}),!c&&r.jsx("div",{className:"absolute inset-0 flex items-center justify-center"}),r.jsx("div",{className:`absolute bottom-4 right-4 w-32 h-24 rounded-lg overflow-hidden border-2 border-white shadow-lg bg-black transition-all ${g||!f?"hidden":""}`,children:r.jsx("video",{ref:e=>{e&&(e.srcObject=f)},autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"})})]}),r.jsxs("div",{className:"flex justify-center gap-4 mt-6",children:[r.jsx("button",{onClick:O,className:`p-3 rounded-full transition ${p?"bg-red-600 text-white":"bg-[rgb(var(--color-surface-hover))] text-[rgb(var(--color-text))]"}`,title:p?"Unmute":"Mute",children:p?r.jsx(H,{size:20}):r.jsx(L,{size:20})}),n.type==="video"&&r.jsx("button",{onClick:D,className:`p-3 rounded-full transition ${g?"bg-red-600 text-white":"bg-[rgb(var(--color-surface-hover))] text-[rgb(var(--color-text))]"}`,title:g?"Turn camera on":"Turn camera off",children:g?r.jsx(J,{size:20}):r.jsx(U,{size:20})}),r.jsx("button",{onClick:S,className:"p-4 rounded-full bg-red-600 text-white transition hover:bg-red-700",title:"Hang up",children:r.jsx($,{size:24})})]})]})}):null};export{q as Calls};
