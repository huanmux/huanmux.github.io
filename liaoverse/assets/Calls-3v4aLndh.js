import{u as V,r as s,j as r,P as L,M as U,V as _,X as F}from"./main-DKXvsTZx.js";import{$ as H,P as z,M as J,V as W}from"./bundler-DFjWqsBn.js";const T=({children:o,onClose:l,wide:f=!1})=>r.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4",onClick:l,children:r.jsxs("div",{className:`bg-[rgb(var(--color-surface))] rounded-lg shadow-xl p-6 w-full ${f?"max-w-lg":"max-w-sm"} relative`,onClick:n=>n.stopPropagation(),children:[r.jsx("button",{onClick:l,className:"absolute top-3 right-3 p-1 rounded-full text-[rgb(var(--color-text-secondary))] hover:bg-[rgb(var(--color-surface-hover))]",children:r.jsx(F,{size:20})}),o]})}),B=()=>{const{user:o}=V(),[l,f]=s.useState(null),[n,N]=s.useState(null),[m,k]=s.useState(null),[c,E]=s.useState(null),[v,C]=s.useState(!1),[b,j]=s.useState(!1),[P,i]=s.useState(null),g=s.useRef(null),x=s.useRef(null),p=s.useRef(n),S=s.useRef(l),u=s.useRef(null);s.useEffect(()=>(u.current=new Audio("https://mux8.com/assets/audio/theme01full.mp3"),u.current.loop=!0,()=>{u.current?.pause(),u.current=null}),[]),s.useEffect(()=>{l?u.current?.play().catch(e=>{console.warn("Ringtone autoplay blocked by browser:",e)}):u.current&&(u.current.pause(),u.current.currentTime=0)},[l]),s.useEffect(()=>{p.current=n,S.current=l},[n,l]);const w=s.useCallback(async e=>{i(null);const t={audio:!0,video:e==="video"};try{const a=await navigator.mediaDevices.getUserMedia(t);return k(a),e==="video"&&j(!1),C(!1),a}catch(a){return console.error("Error getting user media:",a),a.name==="NotFoundError"||a.name==="DevicesNotFoundError"?i("No microphone or camera found."):a.name==="NotAllowedError"||a.name==="PermissionDeniedError"?i(e==="video"?"Microphone/Camera access denied.":"Microphone access denied."):i("Error accessing media devices."),k(null),C(!0),e==="video"&&j(!0),new MediaStream}},[]),d=s.useCallback(()=>{x.current&&(x.current.close(),x.current=null),m?.getTracks().forEach(e=>e.stop()),c?.getTracks().forEach(e=>e.stop()),k(null),E(null),N(null),f(null),C(!1),j(!1),i(null)},[m,c]),R=s.useCallback(()=>{d()},[d]),I=s.useCallback(async(e,t)=>{if(!o||p.current||!g.current)return;const a=await w(t);N({with:e,type:t,isCaller:!0});const h={from:o,type:t},y=g.current.call(e.id,a,{metadata:h});x.current=y,y.on("stream",M=>{E(M)}),y.on("close",()=>{d()}),y.on("error",M=>{console.error("Peer call error:",M),d()})},[o,w,d]),O=s.useCallback(async()=>{if(!l||!o)return;const e=await w(l.type);N({with:l.from,type:l.type,isCaller:!1}),l.peerCall.answer(e),x.current=l.peerCall,l.peerCall.on("stream",t=>{E(t)}),l.peerCall.on("close",()=>{d()}),l.peerCall.on("error",t=>{console.error("Peer call error:",t),d()}),f(null)},[o,l,w,d]),$=s.useCallback(()=>{l&&l.peerCall.close(),f(null)},[l]);s.useEffect(()=>{const e=t=>{const{targetUser:a,type:h}=t.detail;I(a,h)};return window.addEventListener("startCall",e),()=>window.removeEventListener("startCall",e)},[I]),s.useEffect(()=>{if(!o||g.current)return;const e=new H(o.id);return g.current=e,e.on("open",t=>{console.log("PeerJS connected with ID:",t)}),e.on("call",t=>{const a=t.metadata;if(p.current||S.current){t.close();return}t.on("close",()=>{f(h=>h?.peerCall===t?null:h)}),f({from:a.from,type:a.type,peerCall:t})}),e.on("error",t=>{console.error("PeerJS error:",t),t.type==="peer-unavailable"&&p.current&&!x.current?.open&&i(`${p.current.with.display_name} is unreachable.`)}),()=>{e.destroy(),g.current=null}},[o]);const A=()=>{const e=m?.getAudioTracks()||[];e.length>0?(e.forEach(t=>{t.enabled=!t.enabled}),C(!v)):i("No microphone track available.")},D=()=>{const e=m?.getVideoTracks()||[];e.length>0?(e.forEach(t=>{t.enabled=!t.enabled}),j(!b)):i("No camera track available.")};return l?r.jsx(T,{onClose:$,children:r.jsxs("div",{className:"text-center text-[rgb(var(--color-text))]",children:[r.jsx("h3",{className:"text-xl font-bold",children:l.from.display_name}),r.jsxs("p",{className:"text-[rgb(var(--color-text-secondary))]",children:["Incoming ",l.type," call..."]}),r.jsxs("div",{className:"flex justify-center gap-4 mt-6",children:[r.jsx("button",{onClick:$,className:"p-4 rounded-full bg-red-600 text-white transition hover:bg-red-700",title:"Deny",children:r.jsx(z,{size:24})}),r.jsx("button",{onClick:O,className:"p-4 rounded-full bg-green-500 text-white transition hover:bg-green-600",title:"Answer",children:r.jsx(L,{size:24})})]})]})}):n?r.jsx(T,{onClose:R,wide:!0,children:r.jsxs("div",{className:"text-center text-[rgb(var(--color-text))]",children:[r.jsxs("h3",{className:"text-xl font-bold mb-2",children:[n.isCaller&&!c?"Ringing...":"",!n.isCaller||c?`In call with ${n.with.display_name}`:"",n.isCaller&&!c&&r.jsx("span",{className:"block text-sm font-normal text-[rgb(var(--color-text-secondary))]",children:"Waiting for answer..."})]}),P&&r.jsx("p",{className:"text-red-500 text-sm mb-3 bg-red-100 dark:bg-red-900/30 p-2 rounded",children:P}),r.jsxs("div",{className:"relative w-full aspect-video bg-black rounded-lg mb-4 overflow-hidden",children:[r.jsx("video",{ref:e=>{e&&(e.srcObject=c)},autoPlay:!0,playsInline:!0,className:`w-full h-full object-cover ${c?"":"hidden"}`}),!c&&r.jsx("div",{className:"absolute inset-0 flex items-center justify-center"}),r.jsx("div",{className:`absolute bottom-4 right-4 w-32 h-24 rounded-lg overflow-hidden border-2 border-white shadow-lg bg-black transition-all ${b||!m?"hidden":""}`,children:r.jsx("video",{ref:e=>{e&&(e.srcObject=m)},autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"})})]}),r.jsxs("div",{className:"flex justify-center gap-4 mt-6",children:[r.jsx("button",{onClick:A,className:`p-3 rounded-full transition ${v?"bg-red-600 text-white":"bg-[rgb(var(--color-surface-hover))] text-[rgb(var(--color-text))]"}`,title:v?"Unmute":"Mute",children:v?r.jsx(J,{size:20}):r.jsx(U,{size:20})}),n.type==="video"&&r.jsx("button",{onClick:D,className:`p-3 rounded-full transition ${b?"bg-red-600 text-white":"bg-[rgb(var(--color-surface-hover))] text-[rgb(var(--color-text))]"}`,title:b?"Turn camera on":"Turn camera off",children:b?r.jsx(W,{size:20}):r.jsx(_,{size:20})}),r.jsx("button",{onClick:R,className:"p-4 rounded-full bg-red-600 text-white transition hover:bg-red-700",title:"Hang up",children:r.jsx(z,{size:24})})]})]})}):null};export{B as Calls};
